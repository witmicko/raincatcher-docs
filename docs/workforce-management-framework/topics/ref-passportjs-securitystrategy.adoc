[id='ref-passportjs-securitystrategy-{chapter}']
= Defining the Security Strategy for {WFM-RC-NameShort} Passport.js

This section includes:

. xref:understanding-session-management-{chapter}[Understanding Session Management]
. xref:defining-access-control-{chapter}[Defining Access Control]
. xref:defining-password-storage-{chapter}[Defining Password Storage]
. xref:passportauth-authentication-{chapter}[PassportAuth Authentication]
. xref:passportauth-authorization-{chapter}[PassportAuth Authorization]

[id='understanding-session-management-{chapter}']
== Understanding Session Management
Users sessions are stored using `express-session` module.
Visit link:https://github.com/expressjs/session[express-session] to find more information about the available express
session options.

[id='defining-access-control-{chapter}']
== Defining Access Control
The PassportAuth module allows role based access control. Routes are protected by role as shown in the example.
See authService is an implementation of the
link:++../../../api/{WFM-RC-Api-Version}/auth-passport/docs/classes/_src_auth_passportauth_.passportauth.html++[passportAuth]
in the reference application.

[source,typescript]
----
app.get('/testAdminEndpoint', authService.protect('admin'), (req: express.Request, res: express.Response) => {
  res.json({ routeName: '/testAdminEndpoint', msg: 'authorized to access admin endpoint' });
});

----
Demo roles are defined as an array in link:https://github.com/feedhenry-raincatcher/raincatcher-core/blob/master/demo/data/src/users.json[user.json].

[id='defining-password-storage-{chapter}']
== Defining Password Storage

Passport module has build UserRepository interface that can be used to point to user data.
Passwords are stored in datasource that is being configured by developers (possibly external service).
To point Passport to user datasource you need to implement the
link:++../../../api/{WFM-RC-Api-Version}/auth-passport/docs/interfaces/_src_user_userrepository_.userrepository.html#getuserbylogin++[user repository interface]

[id='passportauth-authentication-{chapter}']
== PassportAuth Authentication
From a development point of view {WFM-RC-NameShort} uses the Default Strategy for username/password authentication. Authentication is done on the cloud
server. Passport authentication service is using a default custom strategy that is based on Passport.js local strategy.
Passport's local strategy is agnostic about database type.

Passports using
link:++../../../api/{WFM-RC-Api-Version}/auth-passport/docs/interfaces/_src_auth_passportauth_.endpointsecurity.html#authenticate++[authenticate] middleware for accepting user credentials and creates session entry that holds user.
To access routes user need to login using their credentials. Cookie containing user session key will be used to
authenticate and authorize user requesting server endpoint.

NOTE: For demo the login post route has an authenticate method that checks the userId and password
against the stored user.json file it also checks the user role against the stored role on user.json.

See link:{WFM-RC-Github-Core}{WFM-RC-Branch}{WFM-RC-PassportAuth-Example}[example]

[id='passportauth-authorization-{chapter}']
== PassportAuth Authorization
Authorization is being supported thanks to
link:++../../../api/{WFM-RC-Api-Version}/auth-passport/docs/interfaces/_src_auth_passportauth_.endpointsecurity.html#protect++[protect]
middleware that validates user session id against session and checks permissions.


